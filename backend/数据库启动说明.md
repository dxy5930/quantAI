# 数据库启动配置说明

## 问题描述

每次启动后端都会插入数据的原因是 **TypeORM 的 `synchronize` 功能**：

```typescript
synchronize: true  // ❌ 这会导致每次启动时重建表和重新执行迁移
```

## 解决方案

### 1. 环境变量控制

在 `.env` 文件中配置以下变量：

```bash
# 数据库行为控制
DB_SYNCHRONIZE=false  # 关闭自动同步（推荐）
DB_LOGGING=true       # 控制SQL日志输出  
DB_DROP_SCHEMA=false  # 禁止删除并重建数据库
```

### 2. 不同环境配置

#### 开发环境 (development)
```bash
DB_SYNCHRONIZE=false  # 建议关闭，手动控制数据库变更
DB_LOGGING=true       # 开启日志调试
DB_DROP_SCHEMA=false  # 保留数据
```

#### 生产环境 (production)  
```bash
DB_SYNCHRONIZE=false  # 必须关闭
DB_LOGGING=false      # 关闭详细日志
DB_DROP_SCHEMA=false  # 绝对不能删除数据
```

## TypeORM 配置说明

### synchronize 选项
- **`true`**: 每次启动时自动同步数据库表结构
  - ✅ 开发时方便
  - ❌ 会重新执行迁移文件  
  - ❌ 可能导致数据丢失
  - ❌ 生产环境不安全

- **`false`**: 不自动同步（推荐）
  - ✅ 数据安全
  - ✅ 手动控制变更
  - ✅ 适合生产环境

### dropSchema 选项
- **`true`**: 每次启动时删除并重建所有表
- **`false`**: 保留现有数据（推荐）

### logging 选项
- **`true`**: 打印所有SQL语句
- **`false`**: 不打印SQL语句

## 数据库迁移管理

### 手动运行迁移

```bash
# 查看迁移状态
npm run migration:show

# 运行待处理的迁移
npm run migration:run

# 回滚上一个迁移
npm run migration:revert
```

### 创建新迁移

```bash
# 根据实体变更自动生成迁移
npm run migration:generate -- --name=描述变更内容

# 手动创建空白迁移文件
npm run migration:create -- --name=描述变更内容
```

## 最佳实践

### 1. 生产环境
- 永远设置 `synchronize: false`
- 使用迁移文件管理数据库变更
- 部署前测试所有迁移

### 2. 开发环境
- 建议设置 `synchronize: false`
- 使用迁移文件而不是自动同步
- 定期备份开发数据库

### 3. 迁移文件编写
```sql
-- 使用 INSERT IGNORE 避免重复插入
INSERT IGNORE INTO table_name (...) VALUES (...);

-- 或使用条件检查
INSERT INTO table_name (...)
SELECT ... 
WHERE NOT EXISTS (SELECT 1 FROM table_name WHERE condition);
```

## 故障排除

### 如果数据仍然重复插入

1. **检查环境变量**
   ```bash
   echo $DB_SYNCHRONIZE  # 应该是 false
   ```

2. **检查迁移文件**
   - 确保使用 `INSERT IGNORE` 或条件检查
   - 避免使用 `ON DUPLICATE KEY UPDATE`

3. **清理重复数据**
   ```bash
   # 运行修复脚本
   node scripts/fix-all-duplicate-keys.js
   ```

4. **重置数据库（谨慎）**
   ```bash
   # 删除所有表并重新运行迁移
   npm run db:reset
   ```

## 注意事项

⚠️ **重要**：在生产环境中永远不要使用 `synchronize: true` 或 `dropSchema: true`

⚠️ **备份**：在运行任何数据库操作前，请确保已备份重要数据

⚠️ **测试**：所有数据库变更都应该在开发环境中充分测试 