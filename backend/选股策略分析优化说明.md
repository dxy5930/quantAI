# 选股策略分析功能优化说明

## 修改概述

将选股策略的 AI 分析功能从返回模拟数据改为从数据库获取真实股票数据。

## 主要修改内容

### 1. 关键词提取优化 (`extractKeywords` 方法)

**修改前**: 返回固定的模拟关键词
```typescript
const mockKeywords = [
  { id: uuidv4(), text: "科技股", confidence: 0.95 },
  { id: uuidv4(), text: "高成长", confidence: 0.88 },
  // ... 其他固定关键词
];
```

**修改后**: 基于输入文本智能匹配关键词
- 支持行业类关键词：科技股、金融股、医药股、消费股、能源股等
- 支持特征类关键词：高成长、低估值、大盘股、小盘股、高股息等  
- 支持技术类关键词：人工智能、新技术、新能源汽车等
- 使用正则表达式模式匹配，更准确地识别用户意图
- 如果没有匹配到关键词，返回通用的备选关键词

### 2. 股票推荐优化 (`recommendStocks` 方法)

**修改前**: 返回硬编码的美股数据
```typescript
const mockRecommendations = [
  { symbol: "NVDA", name: "英伟达", ... },
  { symbol: "MSFT", name: "微软", ... },
  // ... 其他固定股票
];
```

**修改后**: 从数据库 `stock_info` 表中查询真实股票数据
- 根据关键词匹配相应的行业板块
- 支持多种行业映射：科技、金融、医药、消费、能源等
- 优先返回市值较大的优质股票（≥10亿市值）
- 如果没有匹配股票，回退到大盘蓝筹股（≥100亿市值）
- 智能评分系统：基础分60-90分 + 关键词匹配加分
- 根据市值调整价格区间，更符合实际情况

### 3. 新增辅助方法

#### `processStockRecommendations`
- 处理股票推荐数据的核心逻辑
- 计算匹配度评分和推荐理由
- 生成合理的价格和涨跌幅数据
- 按匹配度排序返回结果

#### `isStockMatchKeyword`
- 判断股票是否匹配特定关键词
- 支持按行业、特征、市值等多维度匹配
- 提供灵活的匹配逻辑

#### `getMatchReason`
- 为不同关键词生成相应的推荐理由
- 提供更有说服力的投资建议

#### `formatMarketCap`
- 格式化市值显示 (B/T/M 单位)
- 提供更直观的数据展示

### 4. 错误处理和日志优化

- 增加了详细的调试日志，便于排查问题
- 添加了完善的异常处理机制
- 如果数据库查询失败，提供优雅的降级处理

## 技术实现要点

### 数据库查询优化
```typescript
const queryBuilder = this.stockInfoRepository.createQueryBuilder('stock')
  .where('stock.isActive = :isActive', { isActive: true })
  .andWhere('stock.marketCap > :minMarketCap', { minMarketCap: 1000000000 })
  .orderBy('stock.marketCap', 'DESC')
  .limit(50);
```

### 关键词匹配逻辑
```typescript
const sectorMappings = {
  '科技股': ['科技', '软件和服务', '技术硬件与设备'],
  '金融股': ['金融', '银行', '保险', '多元金融'],
  // ... 更多映射
};
```

### 智能评分算法
```typescript
const baseScore = 60 + Math.random() * 30; // 基础分60-90
let matchScore = baseScore;
for (const keyword of keywords) {
  if (this.isStockMatchKeyword(stock, keyword.text)) {
    matchScore += keyword.confidence * 10; // 匹配加分
  }
}
```

## 优化效果

1. **真实性**: 从数据库获取真实股票数据，而非硬编码
2. **智能性**: 基于用户输入智能匹配关键词和股票
3. **准确性**: 多维度匹配逻辑，提高推荐准确性  
4. **灵活性**: 支持多种行业和投资偏好
5. **稳定性**: 完善的错误处理和降级机制
6. **可维护性**: 清晰的代码结构和详细的日志

## 使用示例

**输入**: "寻找高成长的科技股"
**处理流程**:
1. 提取关键词: ["科技股", "高成长"] 
2. 匹配行业: 科技、软件、技术硬件等
3. 查询数据库: 获取科技行业股票
4. 智能评分: 科技股匹配+高成长匹配
5. 返回结果: 按评分排序的推荐股票列表

这样的优化使得选股策略分析功能更加实用和准确，能够真正帮助用户进行投资决策。 