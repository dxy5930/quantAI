# 用户等级功能使用指南

## 概述

本系统引入了用户等级功能，通过不同的等级来区分用户的权限和功能限制。用户等级分为三个级别：普通用户、高级用户和超级用户。

## 用户等级分类

### 1. 普通用户 (Level 1)
- **等级值**: 1
- **名称**: 普通用户
- **权限限制**:
  - 最大策略数量: 10个
  - 每日最大回测次数: 20次
  - 策略分享: ❌ 不支持
  - 数据导出: ❌ 不支持
  - 高级功能: ❌ 不支持

### 2. 高级用户 (Level 2)
- **等级值**: 2
- **名称**: 高级用户
- **权限限制**:
  - 最大策略数量: 50个
  - 每日最大回测次数: 100次
  - 策略分享: ✅ 支持
  - 数据导出: ✅ 支持
  - 高级功能: ✅ 支持

### 3. 超级用户 (Level 3)
- **等级值**: 3
- **名称**: 超级用户
- **权限限制**:
  - 最大策略数量: 无限制
  - 每日最大回测次数: 无限制
  - 策略分享: ✅ 支持
  - 数据导出: ✅ 支持
  - 高级功能: ✅ 支持

## 数据库结构

### 用户表 (users)
```sql
ALTER TABLE users 
ADD COLUMN level INT NOT NULL DEFAULT 1 COMMENT '用户等级：1-普通用户，2-高级用户，3-超级用户';
```

### 表注释
- `users`: 用户信息表，存储系统用户的基本信息、权限、个人资料等数据
- `strategies`: 策略信息表，存储用户创建的交易策略信息，包括选股策略和回测策略
- `backtest_history`: 回测历史表，存储用户执行回测的历史记录，包括回测配置、结果、状态等信息

## API 接口

### 用户等级管理

#### 1. 获取用户权限信息
```http
GET /api/users/permissions
Authorization: Bearer <token>
```

#### 2. 检查策略数量限制
```http
GET /api/users/strategy-limit
Authorization: Bearer <token>
```

#### 3. 更新用户等级（管理员专用）
```http
PUT /api/users/admin/level/:userId
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "level": 2
}
```

#### 4. 批量更新用户等级（管理员专用）
```http
POST /api/users/admin/level/batch
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "userIds": ["uuid1", "uuid2"],
  "level": 2
}
```

#### 5. 获取用户等级统计（管理员专用）
```http
GET /api/users/admin/level-stats
Authorization: Bearer <admin_token>
```

### 策略相关

#### 6. 获取用户策略统计
```http
GET /api/strategies/user-stats
Authorization: Bearer <token>
```

### 回测相关

#### 7. 获取回测统计信息
```http
GET /api/backtest/stats
Authorization: Bearer <token>
```

#### 8. 导出回测数据（高级用户专用）
```http
POST /api/backtest/export
Authorization: Bearer <token>
Content-Type: application/json

{
  "backtestIds": ["uuid1", "uuid2"]
}
```

## 权限检查逻辑

### 1. 策略创建权限检查
```typescript
// 在创建策略时检查用户等级限制
private async checkStrategyCreationPermission(user: User): Promise<void> {
  const permissions = USER_LEVEL_PERMISSIONS[user.level];
  const currentCount = user.strategies.length;
  const maxStrategies = permissions.maxStrategies;

  if (maxStrategies !== -1 && currentCount >= maxStrategies) {
    throw new ForbiddenException(
      `您的用户等级最多只能创建 ${maxStrategies} 个策略`
    );
  }
}
```

### 2. 回测权限检查
```typescript
// 在执行回测时检查每日限制
private async checkBacktestPermission(userId: string): Promise<void> {
  const user = await this.userRepository.findOne({ where: { id: userId } });
  const permissions = USER_LEVEL_PERMISSIONS[user.level];
  const maxBacktestPerDay = permissions.maxBacktestPerDay;

  // 检查今日回测次数...
}
```

### 3. 功能权限检查
```typescript
// 检查高级功能访问权限
async checkPremiumFeatureAccess(userId: string): Promise<void> {
  const user = await this.userRepository.findOne({ where: { id: userId } });
  const permissions = USER_LEVEL_PERMISSIONS[user.level];
  
  if (!permissions.canAccessPremiumFeatures) {
    throw new ForbiddenException("此功能仅限高级用户使用");
  }
}
```

## 使用示例

### 1. 检查用户是否可以创建策略
```typescript
@Post('strategies')
async createStrategy(@Request() req, @Body() createStrategyDto: CreateStrategyDto) {
  // 服务层会自动检查用户等级限制
  return this.strategiesService.create(req.user.id, createStrategyDto);
}
```

### 2. 检查用户是否可以分享策略
```typescript
@Post('strategies/:id/share')
async shareStrategy(@Request() req, @Param('id') id: string) {
  // 服务层会自动检查分享权限
  return this.strategiesService.shareStrategy(id, req.user.id);
}
```

### 3. 管理员更新用户等级
```typescript
@Put('admin/level/:userId')
async updateUserLevel(
  @Request() req,
  @Param('userId') userId: string,
  @Body() updateUserLevelDto: UpdateUserLevelDto
) {
  return this.usersService.updateUserLevel(req.user.id, userId, updateUserLevelDto);
}
```

## 迁移指南

### 1. 执行数据库迁移
```bash
# 执行迁移脚本
mysql -u username -p database_name < src/migrations/001-add-user-level.sql
```

### 2. 验证迁移结果
```sql
-- 检查用户等级字段是否添加成功
DESCRIBE users;

-- 检查用户等级分布
SELECT level, COUNT(*) as count FROM users GROUP BY level;
```

### 3. 更新现有用户等级（可选）
```sql
-- 将特定用户升级为高级用户
UPDATE users SET level = 2 WHERE username IN ('user1', 'user2');

-- 将管理员设置为超级用户
UPDATE users SET level = 3 WHERE role = 'admin';
```

## 注意事项

1. **向后兼容性**: 现有用户默认为普通用户（Level 1）
2. **权限检查**: 所有涉及用户等级的操作都会进行权限检查
3. **错误处理**: 权限不足时会抛出 `ForbiddenException`
4. **管理员权限**: 只有管理员可以修改用户等级
5. **数据完整性**: 用户等级值必须在 1-3 范围内

## 错误代码

- `403 Forbidden`: 用户等级权限不足
- `404 Not Found`: 用户不存在
- `400 Bad Request`: 用户等级值无效

## 扩展功能

### 1. 用户等级权限视图
系统创建了 `user_level_permissions` 视图，方便查询用户权限信息。

### 2. 等级统计函数
提供了 `get_user_level_stats()` 函数，用于获取用户等级分布统计。

### 3. 自动权限检查
在关键操作中自动进行权限检查，确保用户只能执行其等级允许的操作。

## 未来扩展

1. **等级升级机制**: 可以基于用户活跃度、策略质量等指标自动升级用户等级
2. **付费升级**: 集成支付系统，允许用户付费升级等级
3. **临时权限**: 为特定用户临时提升权限
4. **等级有效期**: 为高级用户设置有效期限制
5. **更细粒度权限**: 为不同功能设置更详细的权限控制 