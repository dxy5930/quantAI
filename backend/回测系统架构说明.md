# 回测系统架构说明

## 系统架构

本系统采用三层架构：
1. **前端 (React + TypeScript)** - 用户界面和交互
2. **后端 (NestJS + TypeScript)** - API 服务和业务逻辑
3. **Python分析服务 (FastAPI + Python)** - 量化分析和回测计算

```
前端 → 后端 → Python服务
  ↓      ↓        ↓
UI   业务逻辑   数学计算
```

## 数据流程

### 回测流程
1. 用户在前端配置回测参数（股票、时间、资金等）
2. 前端显示AI分析动画
3. 前端调用后端 `/api/v1/backtest/run` 接口
4. 后端验证用户权限和参数
5. 后端调用Python服务 `http://localhost:8000/api/backtest/run`
6. Python服务执行实际的回测计算
7. Python服务返回结果给后端
8. 后端存储结果到数据库
9. 后端返回结果给前端
10. 前端隐藏动画，显示回测结果

## 接口规范

### 前端 → 后端

**POST /api/v1/backtest/run**

请求参数：
```typescript
{
  strategy_id: string;
  start_date: string;      // "2023-01-01"
  end_date: string;        // "2023-12-31" 
  initial_capital: number; // 100000
  symbols: string[];       // ["AAPL", "GOOGL"]
}
```

响应：
```typescript
{
  success: boolean;
  data: BacktestResult;
  message?: string;
}
```

### 后端 → Python服务

**POST http://localhost:8000/api/backtest/run**

请求参数：
```python
{
  "strategy_id": str,
  "start_date": str,           # "2023-01-01"
  "end_date": str,             # "2023-12-31"
  "initial_capital": float,     # 100000.0
  "symbols": List[str],        # ["AAPL", "GOOGL"]
  "rebalance_frequency": str,  # "monthly"
  "commission": float,         # 0.001
  "backtest_type": str,        # "portfolio"
  "parameters": Dict[str, Any] # {}
}
```

响应：
```python
{
  "success": bool,
  "data": {
    "total_return": float,
    "annual_return": float,
    "sharpe_ratio": float,
    "max_drawdown": float,
    "volatility": float,
    "win_rate": float,
    "total_trades": int,
    "final_value": float,
    "equity_curve": List[Dict],
    "trades": List[Dict],
    "backtest_type": str,
    "portfolio_composition": List[Dict],
    "beta": float,
    "alpha": float,
    "diversification_ratio": float
  },
  "message": str
}
```

## 部署说明

### 1. 启动后端服务

```bash
cd backend
npm install
npm run dev
```

后端服务运行在 `http://localhost:3001`

### 2. 启动Python分析服务

```bash
cd python-analysis-service
pip install -r requirements.txt
python main.py
```

Python服务运行在 `http://localhost:8000`

### 3. 启动前端服务

```bash
cd project
npm install
npm run dev
```

前端服务运行在 `http://localhost:5173`

## 环境配置

### 后端环境变量 (.env)

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASS=123456
DB_NAME=quant_ai_pro

# JWT密钥
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d

# API配置
PORT=3000
API_PREFIX=/api/v1

# Python分析服务配置
PYTHON_SERVICE_URL=http://localhost:8000

# 其他配置
NODE_ENV=development
```

### 前端环境变量 (.env)

```env
VITE_API_BASE_URL=http://localhost:3001
VITE_API_PREFIX=/api/v1
```

## 错误处理

### 降级策略
如果Python服务不可用，后端会自动使用模拟数据作为降级方案，确保系统可用性。

### 错误监控
- 后端记录所有Python服务调用失败的日志
- 前端显示友好的错误提示
- 用户可以重试失败的操作

## 扩展性

### 添加新的分析功能
1. 在Python服务中添加新的接口
2. 在后端添加对应的调用逻辑
3. 在前端添加新的UI组件

### 性能优化
- Python服务可以使用多进程/多线程处理并发请求
- 后端可以添加缓存层减少重复计算
- 数据库可以优化索引提高查询性能

## 监控和运维

### 健康检查
- 后端: `GET /api/v1/system/health`
- Python服务: `GET http://localhost:8000/health`

### 日志
- 后端日志位置: `backend/logs/`
- Python服务日志: 控制台输出

### 性能指标
- 回测请求处理时间
- Python服务响应时间
- 数据库查询性能
- 内存和CPU使用率

## 安全考虑

1. **API访问控制**: 后端使用JWT认证保护所有接口
2. **参数验证**: 前端和后端都进行参数验证
3. **Python服务隔离**: Python服务只在内网访问，不对外开放
4. **超时控制**: 设置合理的请求超时时间防止阻塞

## 注意事项

1. Python服务示例仅用于演示接口规范，生产环境需要实现真实的回测算法
2. 需要确保Python服务的稳定性和性能
3. 建议对Python服务进行负载均衡和容器化部署
4. 定期备份回测结果和配置数据 