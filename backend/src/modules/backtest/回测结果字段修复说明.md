# 回测结果字段修复说明

## 问题描述

在运行回测功能时，遇到了以下数据库错误：
```
Error: Field 'results' doesn't have a default value
```

## 问题原因

1. **实体定义问题**：`BacktestHistory` 实体中的 `results` 字段没有设置为可空（`nullable: true`）
2. **业务逻辑问题**：在创建回测记录时，`results` 字段应该初始为空，因为回测还未完成
3. **数据库约束问题**：MySQL 数据库中的 `results` 字段不允许 NULL 值，但代码没有提供默认值

## 修复方案

### 1. 实体层修复

**文件**: `backend/src/shared/entities/backtest-history.entity.ts`

修改前：
```typescript
@Column({ type: "json", comment: '回测结果数据（JSON格式）' })
results: any;
```

修改后：
```typescript
@Column({ type: "json", nullable: true, comment: '回测结果数据（JSON格式）' })
results?: any;
```

### 2. 服务层修复

**文件**: `backend/src/modules/backtest/backtest.service.ts`

修改前：
```typescript
const backtestHistory = this.backtestHistoryRepository.create({
  userId,
  strategyId: config.strategyId,
  config,
  status: "running",
});
```

修改后：
```typescript
const backtestHistory = this.backtestHistoryRepository.create({
  userId,
  strategyId: config.strategyId,
  config,
  status: "running",
  results: null, // 初始状态下结果为空
});
```

### 3. 数据库层修复

**迁移文件**: `backend/src/migrations/002-fix-backtest-results-nullable.sql`

```sql
-- 修改backtest_history表的results字段，设置为可空
ALTER TABLE `backtest_history` 
MODIFY COLUMN `results` JSON NULL COMMENT '回测结果数据（JSON格式）';

-- 为现有的运行中状态的记录设置results为NULL
UPDATE `backtest_history` 
SET `results` = NULL 
WHERE `status` = 'running' AND `results` IS NOT NULL;
```

## 修复执行

### 方法1：使用修复脚本（推荐）
```bash
cd backend
npm run fix:backtest-results
```

### 方法2：手动执行SQL
```bash
cd backend
mysql -u root -p your_database < src/migrations/002-fix-backtest-results-nullable.sql
```

## 修复验证

修复完成后，可以通过以下方式验证：

1. **重启应用**：确保新的实体定义生效
2. **测试回测功能**：创建新的回测任务，确保不再出现错误
3. **检查数据库**：确认 `backtest_history` 表的 `results` 字段允许 NULL 值

## 预防措施

1. **实体设计**：对于可能在创建时为空的字段，应该设置 `nullable: true`
2. **业务逻辑**：在创建记录时，明确设置所有字段的初始值
3. **数据库约束**：确保数据库约束与实体定义保持一致
4. **测试覆盖**：添加针对这种场景的单元测试和集成测试

## 相关文件

- `backend/src/shared/entities/backtest-history.entity.ts` - 实体定义
- `backend/src/modules/backtest/backtest.service.ts` - 业务逻辑
- `backend/src/migrations/002-fix-backtest-results-nullable.sql` - 数据库迁移
- `backend/scripts/fix-backtest-results.js` - 修复脚本

## 注意事项

1. 在生产环境中执行数据库修改前，请先备份数据
2. 修复后需要重启应用服务
3. 建议在测试环境中先验证修复效果 