# æ•°æ®åº“æŸ¥è¯¢ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨ `backtest.service.ts` ä¸­å‘ç°äº†ä½¿ç”¨MongoDBæŸ¥è¯¢è¯­æ³•çš„é”™è¯¯ï¼š

```
Error: Unknown column '$gte' in 'where clause'
QueryFailedError: Unknown column '$gte' in 'where clause'
```

## ğŸ” é—®é¢˜åŸå› 

ä»£ç ä¸­ä½¿ç”¨äº†MongoDBé£æ ¼çš„æŸ¥è¯¢æ“ä½œç¬¦ï¼Œä½†é¡¹ç›®ä½¿ç”¨çš„æ˜¯MySQLæ•°æ®åº“é…åˆTypeORMã€‚MongoDBå’ŒMySQLçš„æŸ¥è¯¢è¯­æ³•ä¸å…¼å®¹ã€‚

### é”™è¯¯çš„MongoDBè¯­æ³•ï¼š
```typescript
// âŒ é”™è¯¯ï¼šMongoDBè¯­æ³•
createdAt: {
  $gte: today,
  $lt: tomorrow,
} as any

// âŒ é”™è¯¯ï¼šMongoDBè¯­æ³•
id: { $in: backtestIds } as any
```

### æ­£ç¡®çš„TypeORMè¯­æ³•ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šTypeORMè¯­æ³•
createdAt: Between(today, tomorrow)

// âœ… æ­£ç¡®ï¼šTypeORMè¯­æ³•
id: In(backtestIds)
```

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. å¯¼å…¥TypeORMæŸ¥è¯¢æ“ä½œç¬¦

**ä¿®å¤å‰ï¼š**
```typescript
import { Repository } from "typeorm";
```

**ä¿®å¤åï¼š**
```typescript
import { Repository, MoreThanOrEqual, LessThan, In, Between } from "typeorm";
```

### 2. ä¿®å¤æ—¥æœŸèŒƒå›´æŸ¥è¯¢

**ä¿®å¤å‰ï¼š**
```typescript
const todayBacktestCount = await this.backtestHistoryRepository.count({
  where: {
    userId,
    createdAt: {
      $gte: today,
      $lt: tomorrow,
    } as any,
  },
});
```

**ä¿®å¤åï¼š**
```typescript
const todayBacktestCount = await this.backtestHistoryRepository.count({
  where: {
    userId,
    createdAt: Between(today, tomorrow),
  },
});
```

### 3. ä¿®å¤INæŸ¥è¯¢

**ä¿®å¤å‰ï¼š**
```typescript
const backtests = await this.backtestHistoryRepository.find({
  where: {
    id: { $in: backtestIds } as any,
    userId,
  },
  relations: ["strategy"],
});
```

**ä¿®å¤åï¼š**
```typescript
const backtests = await this.backtestHistoryRepository.find({
  where: {
    id: In(backtestIds),
    userId,
  },
  relations: ["strategy"],
});
```

## ğŸ“Š ä¿®å¤ä½ç½®

å…±ä¿®å¤äº†3å¤„æŸ¥è¯¢é”™è¯¯ï¼š

1. **`checkBacktestPermission` æ–¹æ³•** - ç¬¬173-174è¡Œ
   - ä¿®å¤æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼Œç”¨äºæ£€æŸ¥ç”¨æˆ·ä»Šæ—¥å›æµ‹æ¬¡æ•°é™åˆ¶

2. **`getUserBacktestStats` æ–¹æ³•** - ç¬¬209-210è¡Œ
   - ä¿®å¤æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼Œç”¨äºè·å–ç”¨æˆ·ä»Šæ—¥å›æµ‹ç»Ÿè®¡

3. **`exportBacktestData` æ–¹æ³•** - ç¬¬253è¡Œ
   - ä¿®å¤INæŸ¥è¯¢ï¼Œç”¨äºæ‰¹é‡å¯¼å‡ºå›æµ‹æ•°æ®

## ğŸ¯ TypeORMæŸ¥è¯¢æ“ä½œç¬¦å¯¹ç…§è¡¨

| MongoDBæ“ä½œç¬¦ | TypeORMæ“ä½œç¬¦ | è¯´æ˜ |
|---------------|---------------|------|
| `$gte` | `MoreThanOrEqual()` | å¤§äºç­‰äº |
| `$gt` | `MoreThan()` | å¤§äº |
| `$lte` | `LessThanOrEqual()` | å°äºç­‰äº |
| `$lt` | `LessThan()` | å°äº |
| `$in` | `In()` | åŒ…å«åœ¨æ•°ç»„ä¸­ |
| `$nin` | `Not(In())` | ä¸åŒ…å«åœ¨æ•°ç»„ä¸­ |
| `$ne` | `Not()` | ä¸ç­‰äº |
| `$exists` | `IsNull()` / `Not(IsNull())` | å­—æ®µå­˜åœ¨/ä¸å­˜åœ¨ |
| æ—¥æœŸèŒƒå›´ | `Between()` | ä»‹äºä¸¤ä¸ªå€¼ä¹‹é—´ |

## âœ… éªŒè¯ç»“æœ

- âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— TypeScripté”™è¯¯
- âœ… ä¿®å¤äº†æ‰€æœ‰MongoDBæŸ¥è¯¢è¯­æ³•é”™è¯¯
- âœ… ä½¿ç”¨æ­£ç¡®çš„TypeORMæŸ¥è¯¢æ“ä½œç¬¦
- âœ… ä¿æŒäº†åŸæœ‰çš„ä¸šåŠ¡é€»è¾‘ä¸å˜

## ğŸš€ æœ€ä½³å®è·µ

1. **ä½¿ç”¨TypeORMæŸ¥è¯¢æ„å»ºå™¨**ï¼šå¯¹äºå¤æ‚æŸ¥è¯¢ï¼Œæ¨èä½¿ç”¨QueryBuilder
2. **ç±»å‹å®‰å…¨**ï¼šé¿å…ä½¿ç”¨ `as any` å¼ºåˆ¶ç±»å‹è½¬æ¢
3. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨åˆé€‚çš„ç´¢å¼•å’ŒæŸ¥è¯¢æ¡ä»¶
4. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ“ æ³¨æ„äº‹é¡¹

- ç¡®ä¿æ•°æ®åº“è¡¨ç»“æ„ä¸å®ä½“å®šä¹‰ä¸€è‡´
- æ³¨æ„æ—¥æœŸæ—¶åŒºå¤„ç†
- è€ƒè™‘æŸ¥è¯¢æ€§èƒ½å’Œç´¢å¼•ä¼˜åŒ–
- å®šæœŸæ£€æŸ¥å’Œæµ‹è¯•æ•°æ®åº“æŸ¥è¯¢

è¿™æ¬¡ä¿®å¤ç¡®ä¿äº†ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®åœ°åœ¨MySQLæ•°æ®åº“ä¸Šè¿è¡Œï¼Œé¿å…äº†MongoDBæŸ¥è¯¢è¯­æ³•å¯¼è‡´çš„é”™è¯¯ã€‚ 