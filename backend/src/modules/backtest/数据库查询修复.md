# 数据库查询修复说明

## 🐛 问题描述

在 `backtest.service.ts` 中发现了使用MongoDB查询语法的错误：

```
Error: Unknown column '$gte' in 'where clause'
QueryFailedError: Unknown column '$gte' in 'where clause'
```

## 🔍 问题原因

代码中使用了MongoDB风格的查询操作符，但项目使用的是MySQL数据库配合TypeORM。MongoDB和MySQL的查询语法不兼容。

### 错误的MongoDB语法：
```typescript
// ❌ 错误：MongoDB语法
createdAt: {
  $gte: today,
  $lt: tomorrow,
} as any

// ❌ 错误：MongoDB语法
id: { $in: backtestIds } as any
```

### 正确的TypeORM语法：
```typescript
// ✅ 正确：TypeORM语法
createdAt: Between(today, tomorrow)

// ✅ 正确：TypeORM语法
id: In(backtestIds)
```

## 🔧 修复内容

### 1. 导入TypeORM查询操作符

**修复前：**
```typescript
import { Repository } from "typeorm";
```

**修复后：**
```typescript
import { Repository, MoreThanOrEqual, LessThan, In, Between } from "typeorm";
```

### 2. 修复日期范围查询

**修复前：**
```typescript
const todayBacktestCount = await this.backtestHistoryRepository.count({
  where: {
    userId,
    createdAt: {
      $gte: today,
      $lt: tomorrow,
    } as any,
  },
});
```

**修复后：**
```typescript
const todayBacktestCount = await this.backtestHistoryRepository.count({
  where: {
    userId,
    createdAt: Between(today, tomorrow),
  },
});
```

### 3. 修复IN查询

**修复前：**
```typescript
const backtests = await this.backtestHistoryRepository.find({
  where: {
    id: { $in: backtestIds } as any,
    userId,
  },
  relations: ["strategy"],
});
```

**修复后：**
```typescript
const backtests = await this.backtestHistoryRepository.find({
  where: {
    id: In(backtestIds),
    userId,
  },
  relations: ["strategy"],
});
```

## 📊 修复位置

共修复了3处查询错误：

1. **`checkBacktestPermission` 方法** - 第173-174行
   - 修复日期范围查询，用于检查用户今日回测次数限制

2. **`getUserBacktestStats` 方法** - 第209-210行
   - 修复日期范围查询，用于获取用户今日回测统计

3. **`exportBacktestData` 方法** - 第253行
   - 修复IN查询，用于批量导出回测数据

## 🎯 TypeORM查询操作符对照表

| MongoDB操作符 | TypeORM操作符 | 说明 |
|---------------|---------------|------|
| `$gte` | `MoreThanOrEqual()` | 大于等于 |
| `$gt` | `MoreThan()` | 大于 |
| `$lte` | `LessThanOrEqual()` | 小于等于 |
| `$lt` | `LessThan()` | 小于 |
| `$in` | `In()` | 包含在数组中 |
| `$nin` | `Not(In())` | 不包含在数组中 |
| `$ne` | `Not()` | 不等于 |
| `$exists` | `IsNull()` / `Not(IsNull())` | 字段存在/不存在 |
| 日期范围 | `Between()` | 介于两个值之间 |

## ✅ 验证结果

- ✅ 编译成功，无TypeScript错误
- ✅ 修复了所有MongoDB查询语法错误
- ✅ 使用正确的TypeORM查询操作符
- ✅ 保持了原有的业务逻辑不变

## 🚀 最佳实践

1. **使用TypeORM查询构建器**：对于复杂查询，推荐使用QueryBuilder
2. **类型安全**：避免使用 `as any` 强制类型转换
3. **查询优化**：使用合适的索引和查询条件
4. **错误处理**：添加适当的错误处理和日志记录

## 📝 注意事项

- 确保数据库表结构与实体定义一致
- 注意日期时区处理
- 考虑查询性能和索引优化
- 定期检查和测试数据库查询

这次修复确保了系统能够正确地在MySQL数据库上运行，避免了MongoDB查询语法导致的错误。 