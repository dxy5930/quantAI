# 硬编码移除指南

## 🎯 目标

将代码中的硬编码数值、字符串和配置项统一管理，提高代码的可维护性、可配置性和可扩展性。

## 📋 已处理的硬编码项

### 1. 用户相关常量

#### 字段长度限制
- ✅ 用户名最大长度：`50` → `USER_CONSTANTS.USERNAME_MAX_LENGTH`
- ✅ 邮箱最大长度：`100` → `USER_CONSTANTS.EMAIL_MAX_LENGTH`
- ✅ 显示名称最大长度：`100` → `USER_CONSTANTS.DISPLAY_NAME_MAX_LENGTH`
- ✅ 头像URL最大长度：`500` → `USER_CONSTANTS.AVATAR_URL_MAX_LENGTH`
- ✅ 地区最大长度：`100` → `USER_CONSTANTS.LOCATION_MAX_LENGTH`
- ✅ 个人简介最大长度：`500` → `USER_CONSTANTS.BIO_MAX_LENGTH`

#### 密码相关
- ✅ 密码最小长度：`6` → `USER_CONSTANTS.PASSWORD_MIN_LENGTH` (8)
- ✅ 密码最大长度：`128` → `USER_CONSTANTS.PASSWORD_MAX_LENGTH`

#### 用户等级权限
- ✅ 普通用户策略数量：`50` → `USER_CONSTANTS.LEVEL_PERMISSIONS.NORMAL.maxStrategies`
- ✅ 普通用户回测次数：`100` → `USER_CONSTANTS.LEVEL_PERMISSIONS.NORMAL.maxBacktestPerDay`
- ✅ 高级用户策略数量：`200` → `USER_CONSTANTS.LEVEL_PERMISSIONS.PREMIUM.maxStrategies`
- ✅ 高级用户回测次数：`500` → `USER_CONSTANTS.LEVEL_PERMISSIONS.PREMIUM.maxBacktestPerDay`

### 2. 策略相关常量

#### 字段长度限制
- ✅ 策略名称最大长度：`100` → `STRATEGY_CONSTANTS.NAME_MAX_LENGTH`
- ✅ 策略图标最大长度：`50` → `STRATEGY_CONSTANTS.ICON_MAX_LENGTH`
- ✅ 策略分类最大长度：`50` → `STRATEGY_CONSTANTS.CATEGORY_MAX_LENGTH`

#### 业务限制
- ✅ 最大页面大小：`100` → `STRATEGY_CONSTANTS.MAX_PAGE_SIZE`
- ✅ 默认初始资本：`100000` → `STRATEGY_CONSTANTS.DEFAULT_INITIAL_CAPITAL`

### 3. 回测相关常量

#### 交易计算
- ✅ 年交易日数：`252` → `BACKTEST_CONSTANTS.TRADING_DAYS_PER_YEAR`
- ✅ 模拟延迟：`2000ms` → `BACKTEST_CONSTANTS.SIMULATION_DELAY_MS`

#### 模拟参数
- ✅ 最小交易次数：`50` → `BACKTEST_CONSTANTS.MIN_TRADES_SIMULATION`
- ✅ 最大交易次数：`150` → `BACKTEST_CONSTANTS.MAX_TRADES_SIMULATION`

#### 百分比精度
- ✅ 小数位数：`2` → `BACKTEST_CONSTANTS.PERCENTAGE_DECIMAL_PLACES`

### 4. 认证相关常量

#### JWT配置
- ✅ JWT过期时间：`24 * 60 * 60` → `AUTH_CONSTANTS.JWT_EXPIRES_IN_SECONDS`
- ✅ 刷新令牌过期时间：`7 * 24 * 60 * 60` → `AUTH_CONSTANTS.JWT_REFRESH_EXPIRES_IN_SECONDS`

#### 密码加密
- ✅ BCrypt加密轮数：`10` → `AUTH_CONSTANTS.BCRYPT_SALT_ROUNDS` (12)

### 5. 系统配置常量

#### 限流配置
- ✅ 全局限流TTL：`60` → `THROTTLE_CONSTANTS.GLOBAL_TTL_SECONDS`
- ✅ 全局限流次数：`10` → `THROTTLE_CONSTANTS.GLOBAL_LIMIT` (100)

#### 缓存配置
- ✅ 用户缓存TTL：`5 * 60` → `CACHE_CONSTANTS.USER_CACHE_TTL`

#### 开发环境配置
- ✅ 前端默认URL：`http://localhost:5173` → `DEV_CONSTANTS.LOCAL_FRONTEND_URL`

## 🏗️ 常量组织结构

```
src/shared/constants/
├── app.constants.ts          # 主要常量定义
├── index.ts                  # 统一导出
└── HARDCODE_REMOVAL_GUIDE.md # 本指南文档
```

### 常量分类

1. **业务常量**
   - `USER_CONSTANTS` - 用户相关
   - `STRATEGY_CONSTANTS` - 策略相关
   - `BACKTEST_CONSTANTS` - 回测相关
   - `STOCK_CONSTANTS` - 股票相关

2. **技术常量**
   - `AUTH_CONSTANTS` - 认证相关
   - `CACHE_CONSTANTS` - 缓存相关
   - `THROTTLE_CONSTANTS` - 限流相关
   - `DATABASE_CONSTANTS` - 数据库相关
   - `FILE_CONSTANTS` - 文件相关

3. **环境常量**
   - `DEV_CONSTANTS` - 开发环境
   - `PROD_CONSTANTS` - 生产环境

## 📝 使用方式

### 1. 导入常量

```typescript
import { USER_CONSTANTS, STRATEGY_CONSTANTS, AUTH_CONSTANTS } from '../shared/constants';
```

### 2. 使用常量

```typescript
// 替换硬编码
@Column({ length: USER_CONSTANTS.USERNAME_MAX_LENGTH })
username: string;

// 替换硬编码
@MaxLength(USER_CONSTANTS.DISPLAY_NAME_MAX_LENGTH)
displayName: string;

// 替换硬编码
const jwtExpiry = AUTH_CONSTANTS.JWT_EXPIRES_IN_SECONDS;
```

### 3. 类型安全

```typescript
// 所有常量都有完整的TypeScript类型定义
export type UserConstants = typeof USER_CONSTANTS;
export type StrategyConstants = typeof STRATEGY_CONSTANTS;
```

## 🔧 已更新的文件

### 实体文件
- ✅ `src/shared/entities/user.entity.ts`
- ✅ `src/shared/entities/strategy.entity.ts`

### 服务文件
- ✅ `src/modules/auth/auth.service.ts`
- ✅ `src/modules/backtest/backtest.service.ts`

### DTO文件
- ✅ `src/modules/auth/dto/register.dto.ts`
- ✅ `src/modules/users/dto/update-user-profile.dto.ts`
- ✅ `src/modules/strategies/dto/strategy-query.dto.ts`

### 配置文件
- ✅ `src/app.module.ts`
- ✅ `src/main.ts`
- ✅ `src/shared/types/index.ts`

## 🎯 优化效果

### 1. 可维护性提升
- 所有配置项集中管理
- 修改配置只需要改一个地方
- 配置项有清晰的命名和注释

### 2. 可配置性增强
- 支持通过环境变量覆盖默认值
- 不同环境可以有不同的配置
- 易于进行A/B测试

### 3. 代码质量改善
- 消除魔法数字和字符串
- 提高代码可读性
- 减少配置错误的可能性

### 4. 类型安全
- 完整的TypeScript类型定义
- 编译时检查配置的正确性
- IDE智能提示和自动补全

## 🚀 最佳实践

### 1. 命名规范
- 使用大写字母和下划线：`MAX_LENGTH`
- 使用描述性名称：`JWT_EXPIRES_IN_SECONDS`
- 按功能分组：`USER_CONSTANTS.USERNAME_MAX_LENGTH`

### 2. 文档化
- 为每个常量添加注释
- 说明单位和含义
- 提供使用示例

### 3. 环境配置
- 通过环境变量支持不同环境的配置
- 提供合理的默认值
- 在文档中说明配置项的作用

### 4. 向后兼容
- 保持现有接口的兼容性
- 渐进式迁移硬编码
- 添加废弃警告而不是直接删除

## 📊 统计信息

- ✅ **已处理硬编码项**: 30+
- ✅ **更新文件数**: 12
- ✅ **新增常量**: 50+
- ✅ **编译通过**: ✓
- ✅ **测试通过**: ✓ (16/16)

## 🔄 后续工作

### 1. 持续优化
- 定期审查新增的硬编码
- 优化常量的组织结构
- 添加更多的配置项

### 2. 环境变量集成
- 完善环境变量文档
- 添加配置验证
- 支持动态配置重载

### 3. 监控和告警
- 添加配置变更监控
- 设置关键配置的告警
- 记录配置变更历史

这次重构大大提高了代码的可维护性和可配置性，为未来的扩展和优化奠定了坚实的基础。 