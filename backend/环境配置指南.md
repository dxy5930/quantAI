# 环境配置指南

## 概述

本项目支持多环境部署，通过环境变量灵活配置前端域名和其他设置。新的环境配置系统支持：

- 多环境自动检测和配置
- 动态前端URL生成
- CORS域名安全控制
- 请求头域名自动检测

## 环境配置

### 1. 基础配置方式

#### 方式一：直接设置前端URL（推荐）
```bash
# 开发环境
FRONTEND_URL=http://localhost:5174

# 测试环境  
FRONTEND_URL=https://test.your-domain.com

# 生产环境
FRONTEND_URL=https://your-production-domain.com
```

#### 方式二：分环境配置（高级）
```bash
# 设置环境类型
NODE_ENV=production

# 分别配置各环境的前端URL
FRONTEND_URL_DEV=http://localhost:5174
FRONTEND_URL_STAGING=https://staging.your-domain.com  
FRONTEND_URL_PROD=https://your-production-domain.com

# 如果没有设置FRONTEND_URL，系统会根据NODE_ENV自动选择对应的URL
```

### 2. 安全配置

```bash
# 允许的域名列表（用于CORS等安全控制）
ALLOWED_DOMAINS=https://your-domain.com,https://www.your-domain.com,https://app.your-domain.com
```

## 部署示例

### 开发环境 (.env.development)
```bash
NODE_ENV=development
FRONTEND_URL=http://localhost:5174
ALLOWED_DOMAINS=http://localhost:3000,http://localhost:5173,http://localhost:5174

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASS=123456
DB_NAME=quant_ai_pro_dev

# API配置
PORT=3001
API_PREFIX=/api/v1
```

### 测试环境 (.env.staging)
```bash
NODE_ENV=staging
FRONTEND_URL=https://test.your-domain.com
ALLOWED_DOMAINS=https://test.your-domain.com,https://staging.your-domain.com

# 数据库配置
DB_HOST=staging-db.your-domain.com
DB_PORT=3306
DB_USER=staging_user
DB_PASS=staging_password
DB_NAME=quant_ai_pro_staging

# API配置
PORT=3001
API_PREFIX=/api/v1
```

### 生产环境 (.env.production)
```bash
NODE_ENV=production
FRONTEND_URL=https://your-production-domain.com
ALLOWED_DOMAINS=https://your-production-domain.com,https://www.your-production-domain.com

# 数据库配置
DB_HOST=prod-db.your-domain.com
DB_PORT=3306
DB_USER=prod_user
DB_PASS=secure_production_password
DB_NAME=quant_ai_pro

# 安全配置
JWT_SECRET=your-super-secure-jwt-secret-for-production

# API配置
PORT=3001
API_PREFIX=/api/v1
```

## Docker 部署

### 1. 单容器部署
```yaml
# docker-compose.yml
version: '3.8'
services:
  backend:
    build: .
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - FRONTEND_URL=https://your-domain.com
      - ALLOWED_DOMAINS=https://your-domain.com,https://www.your-domain.com
      - DB_HOST=your-db-host
      - DB_USER=your-db-user
      - DB_PASS=your-db-password
      - JWT_SECRET=your-jwt-secret
```

### 2. 多环境部署
```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  backend:
    image: your-registry/chaogu-backend:latest
    environment:
      - NODE_ENV=production
      - FRONTEND_URL=${FRONTEND_URL}
      - ALLOWED_DOMAINS=${ALLOWED_DOMAINS}
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
    env_file:
      - .env.production
```

## Nginx 反向代理

```nginx
# /etc/nginx/sites-available/your-domain
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 后端API代理
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 前端静态文件
    location / {
        root /var/www/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
}
```

## 云服务器部署

### 1. 阿里云ECS
```bash
# 1. 设置环境变量
export NODE_ENV=production
export FRONTEND_URL=https://your-aliyun-domain.com
export ALLOWED_DOMAINS=https://your-aliyun-domain.com

# 2. 启动应用
npm run start:prod
```

### 2. 腾讯云CVM
```bash
# 1. 创建生产环境配置文件
cat > .env.production << EOF
NODE_ENV=production
FRONTEND_URL=https://your-tencent-domain.com
ALLOWED_DOMAINS=https://your-tencent-domain.com
DB_HOST=your-tencent-db-host
JWT_SECRET=your-secure-secret
EOF

# 2. 启动应用
npm run start:prod
```

### 3. AWS EC2
```bash
# 使用AWS参数存储
aws ssm put-parameter --name "/chaogu/prod/frontend-url" --value "https://your-aws-domain.com" --type "String"
aws ssm put-parameter --name "/chaogu/prod/allowed-domains" --value "https://your-aws-domain.com" --type "String"

# 在应用启动脚本中获取参数
export FRONTEND_URL=$(aws ssm get-parameter --name "/chaogu/prod/frontend-url" --query "Parameter.Value" --output text)
export ALLOWED_DOMAINS=$(aws ssm get-parameter --name "/chaogu/prod/allowed-domains" --query "Parameter.Value" --output text)
```

## K8s 部署

```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: chaogu-config
data:
  NODE_ENV: "production"
  FRONTEND_URL: "https://your-k8s-domain.com"
  ALLOWED_DOMAINS: "https://your-k8s-domain.com"
  API_PREFIX: "/api/v1"

---
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chaogu-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chaogu-backend
  template:
    metadata:
      labels:
        app: chaogu-backend
    spec:
      containers:
      - name: backend
        image: your-registry/chaogu-backend:latest
        envFrom:
        - configMapRef:
            name: chaogu-config
        - secretRef:
            name: chaogu-secrets
        ports:
        - containerPort: 3001
```

## 环境检测功能

新的环境配置系统提供以下自动检测功能：

### 1. 请求头域名检测
```typescript
// 系统会自动从请求头检测前端域名
const detectedUrl = environmentService.detectFrontendUrl(request);
```

### 2. 多域名支持
```typescript
// 支持通配符域名配置
ALLOWED_DOMAINS=https://*.your-domain.com,https://your-domain.com
```

### 3. 安全检查
```typescript
// 自动验证域名是否在允许列表中
const isAllowed = environmentService.isAllowedOrigin('https://malicious-site.com'); // false
```

## 迁移指南

### 从旧配置迁移

如果你之前使用的是硬编码的域名配置，按以下步骤迁移：

1. **添加环境变量**
   ```bash
   # 在 .env 文件中添加
   FRONTEND_URL=你的前端域名
   ALLOWED_DOMAINS=允许的域名列表
   ```

2. **更新代码中的引用**
   ```typescript
   // 旧方式
   const url = `${process.env.FRONTEND_URL}/path`;
   
   // 新方式
   const url = environmentService.generateShareUrl('/path');
   ```

3. **测试验证**
   ```bash
   # 测试不同环境的配置
   NODE_ENV=development npm start
   NODE_ENV=production npm start
   ```

## 常见问题

### Q: 为什么分享链接还是显示localhost？
A: 检查环境变量FRONTEND_URL是否正确设置，确保NODE_ENV与部署环境匹配。

### Q: CORS错误怎么解决？
A: 确保ALLOWED_DOMAINS包含了前端域名，支持通配符配置。

### Q: 如何在运行时动态检测域名？
A: 使用`environmentService.detectFrontendUrl(request)`方法，系统会从请求头自动检测。

### Q: 多个前端域名怎么配置？
A: 在ALLOWED_DOMAINS中用逗号分隔多个域名，或使用通配符。

### Q: 如何验证配置是否正确？
A: 启动应用后，检查日志中的环境配置信息，或访问健康检查接口。 