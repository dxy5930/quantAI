# 更新日志

## [1.1.0] - 2024-01-01

### 新增功能 🎉

#### 用户等级系统
- **用户等级分类**: 添加了三个用户等级（普通用户、高级用户、超级用户）
- **权限控制**: 根据用户等级限制不同的功能访问权限
- **策略数量限制**: 
  - 普通用户: 最多10个策略
  - 高级用户: 最多50个策略
  - 超级用户: 无限制
- **回测次数限制**:
  - 普通用户: 每日最多20次回测
  - 高级用户: 每日最多100次回测
  - 超级用户: 无限制
- **高级功能权限**:
  - 策略分享: 仅限高级用户及以上
  - 数据导出: 仅限高级用户及以上
  - 高级功能访问: 仅限高级用户及以上

#### 数据库改进
- **用户表**: 添加 `level` 字段用于存储用户等级
- **表注释**: 为所有数据表添加了详细的中文注释
- **字段注释**: 为所有字段添加了描述性注释
- **索引优化**: 为用户等级字段添加了索引以提高查询性能

#### API 接口扩展
- **用户权限查询**: `GET /api/users/permissions`
- **策略限制检查**: `GET /api/users/strategy-limit`
- **用户等级管理**: `PUT /api/users/admin/level/:userId` (管理员专用)
- **批量等级更新**: `POST /api/users/admin/level/batch` (管理员专用)
- **等级统计信息**: `GET /api/users/admin/level-stats` (管理员专用)
- **回测统计信息**: `GET /api/backtest/stats`
- **数据导出功能**: `POST /api/backtest/export` (高级用户专用)

#### 权限检查机制
- **自动权限验证**: 在关键操作中自动检查用户等级权限
- **友好错误提示**: 权限不足时提供清晰的错误信息和升级建议
- **防护措施**: 确保用户只能执行其等级允许的操作

### 技术改进 🔧

#### 代码结构优化
- **类型定义**: 添加了 `UserLevel` 枚举和权限配置常量
- **DTO 扩展**: 新增用户等级相关的数据传输对象
- **服务层增强**: 为用户、策略、回测服务添加了等级权限检查方法
- **控制器扩展**: 新增用户等级管理相关的API端点

#### 数据库设计
- **迁移脚本**: 提供了完整的数据库迁移脚本
- **视图创建**: 创建了用户等级权限视图便于查询
- **统计函数**: 提供了用户等级分布统计函数
- **数据完整性**: 添加了数据验证和约束

#### 文档完善
- **使用指南**: 提供了详细的用户等级功能使用指南
- **API 文档**: 完善了所有新增API接口的文档
- **迁移指南**: 提供了数据库迁移的详细步骤
- **代码注释**: 为所有新增代码添加了详细的中文注释

### 文件变更 📁

#### 新增文件
- `backend/src/shared/types/index.ts` - 用户等级类型定义
- `backend/src/modules/users/dto/update-user-level.dto.ts` - 用户等级管理DTO
- `backend/src/migrations/001-add-user-level.sql` - 数据库迁移脚本
- `backend/USER_LEVEL_GUIDE.md` - 用户等级功能使用指南
- `backend/CHANGELOG.md` - 更新日志

#### 修改文件
- `backend/src/shared/entities/user.entity.ts` - 添加用户等级字段和详细注释
- `backend/src/shared/entities/strategy.entity.ts` - 添加详细的表和字段注释
- `backend/src/shared/entities/backtest-history.entity.ts` - 添加详细的表和字段注释
- `backend/src/modules/users/dto/update-user-profile.dto.ts` - 添加用户等级字段支持
- `backend/src/modules/users/users.service.ts` - 添加用户等级管理功能
- `backend/src/modules/users/users.controller.ts` - 添加用户等级管理API
- `backend/src/modules/strategies/strategies.service.ts` - 添加策略权限检查
- `backend/src/modules/backtest/backtest.service.ts` - 添加回测权限检查

### 向后兼容性 🔄

- **现有用户**: 自动设置为普通用户（Level 1）
- **API 兼容**: 所有现有API保持向后兼容
- **数据迁移**: 提供了平滑的数据迁移方案
- **功能渐进**: 新功能不影响现有功能的正常使用

### 安全性增强 🔒

- **权限验证**: 所有敏感操作都进行了权限验证
- **管理员权限**: 只有管理员可以修改用户等级
- **数据保护**: 用户只能访问其权限范围内的功能
- **错误处理**: 统一的错误处理和友好的错误提示

### 性能优化 ⚡

- **索引优化**: 为用户等级字段添加了数据库索引
- **查询优化**: 优化了权限检查相关的数据库查询
- **缓存策略**: 用户权限信息可以进行缓存优化
- **批量操作**: 支持批量更新用户等级

### 下一步计划 🚀

1. **前端集成**: 在前端界面中集成用户等级显示和权限控制
2. **等级升级**: 实现基于用户活跃度的自动等级升级机制
3. **付费升级**: 集成支付系统支持付费升级用户等级
4. **更多权限**: 为更多功能添加基于用户等级的权限控制
5. **统计分析**: 提供更详细的用户等级使用统计分析

### 使用说明 📖

详细的使用说明请参考 `USER_LEVEL_GUIDE.md` 文件。

### 迁移步骤 📋

1. 执行数据库迁移脚本：
   ```bash
   mysql -u username -p database_name < src/migrations/001-add-user-level.sql
   ```

2. 重启应用服务：
   ```bash
   npm run start:dev
   ```

3. 验证功能：
   - 检查用户等级字段是否正确添加
   - 测试权限检查功能是否正常工作
   - 验证API接口是否正常响应

### 注意事项 ⚠️

1. 执行迁移前请备份数据库
2. 建议在测试环境中先验证功能
3. 管理员账户建议设置为超级用户等级
4. 注意检查现有用户的等级设置是否正确 