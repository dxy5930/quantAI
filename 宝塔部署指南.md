# FindValue 宝塔面板部署指南

## 域名: www.inhandle.com

### 一、环境准备

#### 1. 宝塔面板基础环境

- **Nginx**: 1.20+
- **MySQL**: 8.0+
- **PHP**: 8.0+ (可选，主要用于宝塔面板)
- **Node.js**: 18.0+
- **Python**: 3.9+
- **PM2**: 最新版本
- **Redis**: 6.0+ (可选，用于缓存)

#### 2. 安装必要软件

```bash
# 在宝塔面板软件商店安装：
# - Nginx
# - MySQL 8.0
# - Node.js 版本管理器
# - Python 项目管理器
# - PM2 管理器
# - Redis (可选)
```

### 二、项目部署步骤

#### 1. 创建网站

- 在宝塔面板中创建网站
- 域名: `www.inhandle.com`
- 根目录: `/www/wwwroot/www.inhandle.com`
- PHP 版本: 纯静态 (不需要 PHP)

#### 2. 配置 SSL 证书

- 在宝塔面板 SSL 设置中申请 Let's Encrypt 证书
- 或上传自己的 SSL 证书
- 开启强制 HTTPS

#### 3. 数据库配置

```bash
# 在宝塔面板MySQL中执行 init-database.sql
# 创建数据库: find_value
# 创建用户: find_value_user
# 密码: FindValue123
```

#### 4. 部署代码

```bash
# 进入网站根目录
cd /www/wwwroot/www.inhandle.com

# 克隆代码
git clone https://github.com/dxy5930/quantAI.git .

# 执行部署脚本
chmod +x deploy.sh
./deploy.sh
```

#### 5. 配置 Nginx

- 将 `nginx.conf` 内容复制到宝塔面板网站设置的 Nginx 配置中
- 重载 Nginx 配置

### 三、服务管理

#### 1. 使用 PM2 管理服务

```bash
# 查看服务状态
pm2 status

# 重启所有服务
pm2 restart all

# 查看日志
pm2 logs

# 停止服务
pm2 stop all
```

#### 2. 服务端口说明

- **前端**: 通过 Nginx 直接访问静态文件
- **后端 API**: 3000 端口 (通过 Nginx 代理到 /api/)
- **Python 分析服务**: 8000 端口 (通过 Nginx 代理到 /python-api/)
- **股票爬虫**: 后台服务，无对外端口

### 四、访问地址

- **前端网站**: https://www.inhandle.com
- **后端 API**: https://www.inhandle.com/api/v1
- **Python 服务**: https://www.inhandle.com/python-api
- **健康检查**: https://www.inhandle.com/health

### 五、监控和维护

#### 1. 日志文件位置

```
backend/logs/          # 后端日志
python-analysis-service/logs/  # Python服务日志
stock-crawler/logs/    # 爬虫日志
/www/wwwlogs/         # Nginx访问日志
```

#### 2. 定期维护任务

```bash
# 每天凌晨2点清理日志 (添加到宝塔计划任务)
0 2 * * * find /www/wwwroot/www.inhandle.com/*/logs -name "*.log" -mtime +7 -delete

# 每周日凌晨3点重启服务
0 3 * * 0 cd /www/wwwroot/www.inhandle.com && pm2 restart all

# 每月1号备份数据库
0 0 1 * * mysqldump -u find_value_user -p'FindValue123' find_value > /www/backup/findvalue_$(date +\%Y\%m\%d).sql
```

### 六、安全配置

#### 1. 防火墙设置

- 只开放 80, 443, 22, 8888 端口
- 3000, 8000 端口仅内网访问

#### 2. 数据库安全

- 修改默认密码
- 限制远程访问
- 定期备份

#### 3. 文件权限

```bash
# 设置正确的文件权限
chown -R www:www /www/wwwroot/www.inhandle.com
chmod -R 755 /www/wwwroot/www.inhandle.com
```

### 七、故障排查

#### 1. 常见问题

- **服务无法启动**: 检查端口占用和权限
- **数据库连接失败**: 检查数据库配置和网络
- **前端页面空白**: 检查构建文件和 Nginx 配置
- **API 请求失败**: 检查后端服务状态和代理配置

#### 2. 调试命令

```bash
# 检查端口占用
netstat -tlnp | grep :3000
netstat -tlnp | grep :8000

# 检查服务状态
pm2 status
systemctl status nginx
systemctl status mysql

# 查看实时日志
pm2 logs --lines 100
tail -f /www/wwwlogs/www.inhandle.com.log
```

### 八、更新部署

```bash
# 拉取最新代码
git pull origin master

# 重新构建和部署
./deploy.sh

# 或者分别更新各个服务
cd backend && npm run build && pm2 restart findvalue-backend
cd project && npm run build:prod
pm2 restart findvalue-python-service
pm2 restart findvalue-stock-crawler
```

---

**注意事项:**

1. 首次部署前请确保所有环境依赖已安装
2. 修改所有默认密码和密钥
3. 定期备份数据库和重要文件
4. 监控服务器资源使用情况
5. 及时更新系统和软件包
